name: Claude Assistant

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      task:
        description: 'Task for Claude to perform'
        required: true
        type: string

jobs:
  claude-assistant:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Process Issue or Comment
        if: github.event_name != 'workflow_dispatch'
        uses: anthropics/claude-code-action@v1
        with:
          api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-3-5-sonnet-20241022
          prompt: |
            You are a helpful assistant for this TO-DO List web application repository.
            
            Repository context:
            - This is a web-based todo management system
            - Built with HTML, CSS, and JavaScript
            - Features include task management, priorities, due dates, and file attachments
            
            Please help with:
            1. Bug reports and troubleshooting
            2. Feature requests and implementation suggestions  
            3. Code improvements and optimizations
            4. Documentation updates
            5. General questions about the application
            
            Issue/Comment: ${{ github.event.issue.body || github.event.comment.body }}
            
            Provide helpful, actionable responses. If code changes are needed, suggest specific implementations.
          max-tokens: 3000

      - name: Manual Task Execution
        if: github.event_name == 'workflow_dispatch'
        uses: anthropics/claude-code-action@v1
        with:
          api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-3-5-sonnet-20241022
          prompt: |
            You are a development assistant for this TO-DO List web application.
            
            Task to perform: ${{ github.event.inputs.task }}
            
            Please analyze the current codebase and provide:
            1. Implementation plan
            2. Code changes needed
            3. Testing recommendations
            4. Documentation updates if needed
            
            Focus on maintaining code quality and following best practices.
          max-tokens: 4000

      - name: Comment Response
        if: github.event_name == 'issues' || github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const response = `## ü§ñ Claude Assistant Response
            
            Thank you for your ${github.event_name === 'issues' ? 'issue' : 'comment'}! 
            
            I've analyzed your request and provided feedback in the workflow logs. 
            For detailed assistance, please check the [workflow run logs](${context.payload.repository.html_url}/actions/runs/${context.runId}).
            
            ### Quick Help
            - üêõ **Bug Reports**: Include steps to reproduce and expected behavior
            - ‚ú® **Feature Requests**: Describe the desired functionality and use case
            - ‚ùì **Questions**: Feel free to ask about any aspect of the application
            
            ---
            *Powered by Claude Assistant Action*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: response
            });